<html>
    <head>
        <script src="localforage.min.js"></script>
        <!--<script src="https://cdn.rawgit.com/SheetJS/js-crc32/master/crc32.js"></script> -->
        <script src="crc32.js"></script>
        <script src="architecture.js"></script>
        <script src="jszip.js"></script>
        <script src="mapexplorer.js"></script>
        <script src="raphael.min.js"></script>
    </head>
    <body>
        <h2>Map file unpacker</h2>
        <div style="display: flex">
            <div style="flex: 0 0 25%">
                Map file: <input type="file" name="mapfile" id="mapfileselect"><button onclick="convert_map_to_zip();" type="button" id="converttozip" disabled>Convert to ZIP</button>
            </div>

            <div style="flex: 1">
                Zip file: <input type="file" name="zipfile" id="zipfileselect"><button onclick="convert_zip_to_map();" type="button" id="converttomap" disabled>Convert to MAP</button>
            </div>
        </div>

        <br>
        
        <hr>

        <br>

        <h2>Map tile section explorer</h2>
        Note: unpack your map first, then select a tile data section below (a tile data section is usually of size (KB): 79, 158, 315, ...)
        <br><br>

        <div style="display: flex">
            <div style="flex: 0 0 25%">
                Tile section file: <input type="file" name="tilesectionfile" id="tilesectionfileselect"><button onclick="load_tilesection();" type="button" id="loadtilesection" disabled>Load tilesection</button>
            </div>
            <div style="flex: 0 0 15%">
                Render from row: <input type="number" id="load_tiles_from_row" name="load_tiles_from_row_element" step="1" min=1 max=400 value=0>
            </div>
            <div style="flex: 0 0 15%">
                Render n rows: <input type="number" id="load_tiles_n_rows" name="load_tiles_n_rows_element" step="1" min=1 max=400 value=40>
            </div>
            <div style="flex: 0 0 15%">
                Tile width: <input type="number" id="load_tiles_tile_width" name="load_tiles_tile_width" step="1" min=1 value=8>
            </div>
            <div style="flex: 0 0 15%">
                Tile height: <input type="number" id="load_tiles_tile_height" name="load_tiles_tile_hight" step="1" min=1 value=4>
            </div>
        </div>

        <div id="tilesectiondisplay">
            <div id="paper">

            </div>
        </div>
        
        <script type="text/javascript">
                (function() {
                    // Key for local storage, use to save and access.
                    var FILE_KEY = 'mapfile';
    
                    // fire processUpload when the user uploads a file.
                    document.querySelector('#mapfileselect').addEventListener('change', handleFileUpload, false);
    
                    // Log any previously saved file.
                    //console.log('previous save: ', retrieveSave());
    
                    // Setup file reading
                    var reader = new FileReader();
                    reader.onload = handleFileRead;
    
                    function handleFileUpload(event) {
                        var file = event.target.files[0];
                        if(document.querySelector('#mapfileselect').files.length > 0) {
                            document.querySelector('#converttozip').removeAttribute('disabled', false);
                        } else {
                            document.querySelector('#converttozip').setAttribute('disabled', true);
                        }
//                        reader.readAsBinaryString(file); // fires onload when done.
                        //localforage.setItem(FILE_KEY, file);
                    }
    
                    function handleFileRead(event) {
                        return localforage.setItem(FILE_KEY, event.target.result);
                    }
    
                    function retrieveSave() {
                        return localforage.getItem(FILE_KEY);
                    }
                })();

                (function() {
                    // Key for local storage, use to save and access.
                    var FILE_KEY = 'zipfile';
    
                    // fire processUpload when the user uploads a file.
                    document.querySelector('#zipfileselect').addEventListener('change', handleFileUpload, false);
    
                    // Log any previously saved file.
                    //console.log('previous save: ', retrieveSave());
    
                    // Setup file reading
                    var reader = new FileReader();
                    reader.onload = handleFileRead;
    
                    function handleFileUpload(event) {
                        var file = event.target.files[0];
                        if(document.querySelector('#zipfileselect').files.length > 0) {
                            document.querySelector('#converttomap').removeAttribute('disabled', false);
                        } else {
                            document.querySelector('#converttomap').setAttribute('disabled', true);
                        }
//                        reader.readAsBinaryString(file); // fires onload when done.
                        //localforage.setItem(FILE_KEY, file);
                    }
    
                    function handleFileRead(event) {
                        return localforage.setItem(FILE_KEY, event.target.result);
                    }
    
                    function retrieveSave() {
                        return localforage.getItem(FILE_KEY);
                    }
                })();

                (function() {
                    // Key for local storage, use to save and access.
                    var FILE_KEY = 'tilesectionfile';
    
                    // fire processUpload when the user uploads a file.
                    document.querySelector('#tilesectionfileselect').addEventListener('change', handleFileUpload, false);
    
                    // Log any previously saved file.
                    //console.log('previous save: ', retrieveSave());
    
                    // Setup file reading
                    var reader = new FileReader();
                    reader.onload = handleFileRead;
    
                    function handleFileUpload(event) {
                        var file = event.target.files[0];
                        if(document.querySelector('#tilesectionfileselect').files.length > 0) {
                            document.querySelector('#loadtilesection').removeAttribute('disabled', false);
                        } else {
                            document.querySelector('#loadtilesection').setAttribute('disabled', true);
                        }
//                        reader.readAsBinaryString(file); // fires onload when done.
                        //localforage.setItem(FILE_KEY, file);
                    }
    
                    function handleFileRead(event) {
                        return localforage.setItem(FILE_KEY, event.target.result);
                    }
    
                    function retrieveSave() {
                        return localforage.getItem(FILE_KEY);
                    }
                })();
                
                var download_blob = (function () {
                    var a = document.createElement("a");
                    document.body.appendChild(a);
                    a.style = "display: none";
                    return function (blob, fileName) {
                        var url = window.URL.createObjectURL(blob);
                        a.href = url;
                        a.download = fileName;
                        a.click();
                        window.URL.revokeObjectURL(url);
                    };
                }());
                
                (function() {
                    paper = new Raphael(document.getElementById("paper"), width=1904, height=900);
                    //paper.setViewBox(800, 0, 100, 100, true);


                })()

        </script>
        
        <script type="text/javascript" src="pkware.js"></script>
        <script type="text/javascript" src="interface.js"></script>
    </body>
    
</html>